---
- name: Create backup directory
  file:
    path: "{{ samtrader_backup_dir }}"
    state: directory
    owner: samtrader
    group: samtrader
    mode: '0750'

- name: Deploy backup script
  copy:
    dest: /usr/local/bin/samtrader-backup.sh
    content: |
      #!/bin/bash
      set -euo pipefail

      DB_PATH="${SAMTRADER_DB:-{{ samtrader_db_path }}}"
      BACKUP_DIR="${SAMTRADER_BACKUP_DIR:-{{ samtrader_backup_dir }}}"
      TIMESTAMP=$(date +%Y%m%d-%H%M%S)
      BACKUP_FILE="${BACKUP_DIR}/samtrader-${TIMESTAMP}.db"

      mkdir -p "${BACKUP_DIR}"
      sqlite3 "${DB_PATH}" ".backup '${BACKUP_FILE}'"
      gzip "${BACKUP_FILE}"

      echo "Backup created: ${BACKUP_FILE}.gz"
    owner: root
    group: root
    mode: '0755'

- name: Deploy backup rotation script
  copy:
    dest: /usr/local/bin/samtrader-rotate-backups.sh
    content: |
      #!/bin/bash
      set -euo pipefail

      BACKUP_DIR="${SAMTRADER_BACKUP_DIR:-{{ samtrader_backup_dir }}}"

      RETENTION_DAILY={{ samtrader_backup_retention_daily }}
      RETENTION_WEEKLY={{ samtrader_backup_retention_weekly }}
      RETENTION_MONTHLY={{ samtrader_backup_retention_monthly }}

      # Build a list of backups to keep (weekly = most recent per week, monthly = most recent per month)
      KEEP_LIST=$(mktemp)
      trap 'rm -f "${KEEP_LIST}"' EXIT

      # Keep all backups newer than RETENTION_DAILY days
      find "${BACKUP_DIR}" -name "samtrader-*.db.gz" -type f -mtime -${RETENTION_DAILY} >> "${KEEP_LIST}"

      # Keep one backup per week for the last RETENTION_WEEKLY weeks
      for i in $(seq 1 ${RETENTION_WEEKLY}); do
        days_ago=$(( i * 7 ))
        days_ago_end=$(( days_ago + 7 ))
        find "${BACKUP_DIR}" -name "samtrader-*.db.gz" -type f \
          -mtime +${days_ago} -mtime -${days_ago_end} | sort -r | head -1 >> "${KEEP_LIST}"
      done

      # Keep one backup per month for the last RETENTION_MONTHLY months
      for i in $(seq 1 ${RETENTION_MONTHLY}); do
        days_ago=$(( i * 30 ))
        days_ago_end=$(( days_ago + 30 ))
        find "${BACKUP_DIR}" -name "samtrader-*.db.gz" -type f \
          -mtime +${days_ago} -mtime -${days_ago_end} | sort -r | head -1 >> "${KEEP_LIST}"
      done

      # Delete any backup not in the keep list
      find "${BACKUP_DIR}" -name "samtrader-*.db.gz" -type f | while read -r f; do
        if ! grep -qxF "${f}" "${KEEP_LIST}"; then
          rm -f "${f}"
          echo "Removed: ${f}"
        fi
      done

      echo "Backup rotation completed"
    owner: root
    group: root
    mode: '0755'

- name: Deploy cron configuration for backups
  copy:
    dest: /etc/cron.d/samtrader-backup
    content: |
      # /etc/cron.d/samtrader-backup
      0 3 * * * samtrader /usr/local/bin/samtrader-backup.sh
      5 3 * * * samtrader /usr/local/bin/samtrader-rotate-backups.sh
    owner: root
    group: root
    mode: '0644'
