# Samtrader Deployment

This directory contains deployment infrastructure for running samtrader on a Debian server.

## Prerequisites

- Ansible 2.9+
- Vagrant (for local testing)
- VirtualBox or libvirt (for Vagrant)
- Built samtrader binary

## Quick Start

### 1. Build the binary

```bash
cargo build --release --features sqlite,web
```

### 2. Start the test VM

```bash
cd deploy
vagrant up
```

### 3. Run the Ansible playbook

```bash
cd ansible
ansible-playbook -i inventory.vagrant.ini playbook.yml
```

### 4. Verify the deployment

```bash
./verify-deployment.sh
```

### 5. Test backup rotation

```bash
./test-rotation.sh
```

## Directory Structure

```
deploy/
├── Vagrantfile              # Local test VM configuration
├── verify-deployment.sh     # Post-deployment verification script
├── test-rotation.sh         # Backup rotation test script
├── ansible/
│   ├── playbook.yml         # Main Ansible playbook
│   ├── inventory.ini        # Production inventory template
│   ├── inventory.vagrant.ini # Local testing inventory
│   └── roles/
│       ├── base/            # SSH hardening, firewall, packages
│       ├── caddy/           # Reverse proxy with HTTPS
│       ├── samtrader/       # Application service
│       └── backup/          # Backup and rotation scripts
└── Caddyfile               # Static Caddyfile (for reference)
```

## Verification Checklist

After deployment, verify:

1. **Service Status**
   - `systemctl is-active samtrader` returns `active`
   - `systemctl is-active caddy` returns `active`

2. **HTTPS**
   - Caddy responds on port 443
   - Certificate is valid (auto-generated by Caddy)

3. **Backups**
   - `/usr/local/bin/samtrader-backup.sh` is executable
   - Running it creates a `.db.gz` file in `/var/backups/samtrader`
   - Backup file is a valid SQLite database (check with `zcat file.db.gz | head -c 16`)

4. **Rotation**
   - `/usr/local/bin/samtrader-rotate-backups.sh` is executable
   - Test with `test-rotation.sh` to verify retention logic

5. **Cron**
   - `/etc/cron.d/samtrader-backup` exists
   - Backups run daily at 03:00
   - Rotation runs daily at 03:05

## Production Deployment

1. Copy `inventory.ini` and update with your server details
2. Set required variables:
   - `samtrader_domain` - Your domain name
   - `samtrader_auth_password` - Admin password (use ansible-vault)
3. Run: `ansible-playbook -i inventory.ini playbook.yml`

## Troubleshooting

### Service won't start

Check logs:
```bash
journalctl -u samtrader -f
```

### Caddy issues

Check Caddy logs:
```bash
journalctl -u caddy -f
```

### Backup failures

Ensure the samtrader user has write access:
```bash
ls -la /var/backups/samtrader
ls -la /var/lib/samtrader
```
