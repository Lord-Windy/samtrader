<div id="report-content">
    <h1>Backtest Report</h1>

    <section>
        <h2>Strategy Summary</h2>
        <table>
            <tr><th>Property</th><th>Value</th></tr>
            <tr><td>Name</td><td>{{ strategy.name }}</td></tr>
            <tr><td>Description</td><td>{{ strategy.description }}</td></tr>
            <tr><td>Entry Rule (Long)</td><td>{{ strategy.entry_long }}</td></tr>
            <tr><td>Exit Rule (Long)</td><td>{{ strategy.exit_long }}</td></tr>
            <tr><td>Entry Rule (Short)</td><td>{% if let Some(r) = strategy.entry_short.as_ref() %}{{ r }}{% else %}N/A{% endif %}</td></tr>
            <tr><td>Exit Rule (Short)</td><td>{% if let Some(r) = strategy.exit_short.as_ref() %}{{ r }}{% else %}N/A{% endif %}</td></tr>
            <tr><td>Position Size</td><td>{{ "{:.1}"|format(strategy.position_size * 100.0) }}%</td></tr>
            <tr><td>Stop Loss</td><td>{{ "{:.1}"|format(strategy.stop_loss_pct) }}%</td></tr>
            <tr><td>Take Profit</td><td>{{ "{:.1}"|format(strategy.take_profit_pct) }}%</td></tr>
            <tr><td>Max Positions</td><td>{{ strategy.max_positions }}</td></tr>
            <tr><td>Start Date</td><td>{{ start_date }}</td></tr>
            <tr><td>End Date</td><td>{{ end_date }}</td></tr>
            <tr><td>Initial Capital</td><td>${{ "{:.0}"|format(initial_capital) }}</td></tr>
        </table>
    </section>

    <section>
        <h2>Aggregate Metrics</h2>
        <table>
            <tr><th>Metric</th><th>Value</th></tr>
            <tr><td>Total Return</td><td class="{% if metrics.total_return > 0.0 %}positive{% else if metrics.total_return < 0.0 %}negative{% else %}neutral{% endif %}">{{ "{:.2}"|format(metrics.total_return * 100.0) }}%</td></tr>
            <tr><td>Annualized Return</td><td class="{% if metrics.annualized_return > 0.0 %}positive{% else if metrics.annualized_return < 0.0 %}negative{% else %}neutral{% endif %}">{{ "{:.2}"|format(metrics.annualized_return * 100.0) }}%</td></tr>
            <tr><td>Sharpe Ratio</td><td>{{ "{:.2}"|format(metrics.sharpe_ratio) }}</td></tr>
            <tr><td>Sortino Ratio</td><td>{{ "{:.2}"|format(metrics.sortino_ratio) }}</td></tr>
            <tr><td>Max Drawdown</td><td class="negative">-{{ "{:.2}"|format(metrics.max_drawdown * 100.0) }}%</td></tr>
            <tr><td>Max Drawdown Duration</td><td>{{ "{:.0}"|format(metrics.max_drawdown_duration) }} days</td></tr>
            <tr><td>Total Trades</td><td>{{ metrics.total_trades }}</td></tr>
            <tr><td>Winning Trades</td><td>{{ metrics.winning_trades }}</td></tr>
            <tr><td>Losing Trades</td><td>{{ metrics.losing_trades }}</td></tr>
            <tr><td>Break-Even Trades</td><td>{{ metrics.break_even_trades }}</td></tr>
            <tr><td>Win Rate</td><td>{{ "{:.1}"|format(metrics.win_rate * 100.0) }}%</td></tr>
            <tr><td>Profit Factor</td><td>{% if metrics.profit_factor.is_infinite() %}&infin;{% else %}{{ "{:.2}"|format(metrics.profit_factor) }}{% endif %}</td></tr>
            <tr><td>Average Win</td><td class="positive">${{ "{:.2}"|format(metrics.average_win) }}</td></tr>
            <tr><td>Average Loss</td><td class="negative">-${{ "{:.2}"|format(metrics.average_loss.abs()) }}</td></tr>
            <tr><td>Largest Win</td><td class="positive">${{ "{:.2}"|format(metrics.largest_win) }}</td></tr>
            <tr><td>Largest Loss</td><td class="negative">-${{ "{:.2}"|format(metrics.largest_loss.abs()) }}</td></tr>
            <tr><td>Avg Trade Duration</td><td>{{ "{:.1}"|format(metrics.average_trade_duration) }} days</td></tr>
        </table>
    </section>

    <section>
        <h2>Equity Chart</h2>
        <div class="chart">{{ equity_svg|safe }}</div>
    </section>

    <section>
        <h2>Drawdown Chart</h2>
        <div class="chart">{{ drawdown_svg|safe }}</div>
    </section>

    {% if let Some(results) = code_results %}
        {% if !results.is_empty() %}
        <section>
            <h2>Universe Summary</h2>
            <table>
                <thead>
                    <tr><th>Code</th><th>Trades</th><th>Win Rate</th><th>Total PnL</th><th>Largest Win</th><th>Largest Loss</th></tr>
                </thead>
                <tbody>
                    {% for cr in results %}
                    <tr>
                        <td>{{ cr.code }}</td>
                        <td>{{ cr.total_trades }}</td>
                        <td>{{ "{:.1}"|format(cr.win_rate * 100.0) }}%</td>
                        <td class="{% if cr.total_pnl > 0.0 %}positive{% else if cr.total_pnl < 0.0 %}negative{% else %}neutral{% endif %}">${{ "{:.0}"|format(cr.total_pnl) }}</td>
                        <td class="positive">${{ "{:.0}"|format(cr.largest_win) }}</td>
                        <td class="negative">-${{ "{:.0}"|format(cr.largest_loss.abs()) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>

        {% for cr in results %}
        <section>
            <details>
                <summary>Per-Code Details: {{ cr.code }}</summary>
                <table>
                    <tr><th>Metric</th><th>Value</th></tr>
                    <tr><td>Total Trades</td><td>{{ cr.total_trades }}</td></tr>
                    <tr><td>Winning Trades</td><td>{{ cr.winning_trades }}</td></tr>
                    <tr><td>Losing Trades</td><td>{{ cr.losing_trades }}</td></tr>
                    <tr><td>Win Rate</td><td>{{ "{:.1}"|format(cr.win_rate * 100.0) }}%</td></tr>
                    <tr><td>Total PnL</td><td class="{% if cr.total_pnl > 0.0 %}positive{% else if cr.total_pnl < 0.0 %}negative{% else %}neutral{% endif %}">${{ "{:.0}"|format(cr.total_pnl) }}</td></tr>
                    <tr><td>Largest Win</td><td class="positive">${{ "{:.0}"|format(cr.largest_win) }}</td></tr>
                    <tr><td>Largest Loss</td><td class="negative">-${{ "{:.0}"|format(cr.largest_loss.abs()) }}</td></tr>
                </table>
            </details>
        </section>
        {% endfor %}
        {% endif %}
    {% endif %}

    {% if !trades.is_empty() %}
    <section>
        <h2>Trade Log</h2>
        <table>
            <thead>
                <tr><th>#</th><th>Code</th><th>Entry Date</th><th>Exit Date</th><th>Qty</th><th>Entry Price</th><th>Exit Price</th><th>PnL</th></tr>
            </thead>
            <tbody>
                {% for trade in trades %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ trade.code }}</td>
                    <td>{{ trade.entry_date }}</td>
                    <td>{{ trade.exit_date }}</td>
                    <td>{{ trade.quantity }}</td>
                    <td>${{ "{:.2}"|format(trade.entry_price) }}</td>
                    <td>${{ "{:.2}"|format(trade.exit_price) }}</td>
                    <td class="{% if trade.pnl > 0.0 %}positive{% else if trade.pnl < 0.0 %}negative{% else %}neutral{% endif %}">${{ "{:.0}"|format(trade.pnl) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>
    {% endif %}

    {% if !monthly_returns.is_empty() %}
    <section>
        <h2>Monthly Returns</h2>
        <table class="monthly-returns">
            <thead>
                <tr><th>Year</th><th>Jan</th><th>Feb</th><th>Mar</th><th>Apr</th><th>May</th><th>Jun</th><th>Jul</th><th>Aug</th><th>Sep</th><th>Oct</th><th>Nov</th><th>Dec</th></tr>
            </thead>
            <tbody>
                {% for row in monthly_returns %}
                <tr>
                    <td><strong>{{ row.year }}</strong></td>
                    {% for month in 0..12 %}
                        {% if let Some(pct) = row.value_at(month) %}
                            <td class="{{ row.class_for(month) }}">{{ "{:.1}"|format(pct) }}%</td>
                        {% else %}
                            <td class="neutral">-</td>
                        {% endif %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>
    {% endif %}

    {% if !skipped.is_empty() %}
    <section>
        <h2>Skipped Codes</h2>
        <ul>
            {% for s in skipped %}
            <li>{{ s.code }}: {{ s.reason }}</li>
            {% endfor %}
        </ul>
    </section>
    {% endif %}
</div>
